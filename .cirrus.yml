env:
    CONFIG: env.conf
    CIRRUS_CLONE_DEPTH: 1
    CIRRUS_WORKING_DIR: "/tmp/ci"
    CIRRUS_SHELL: bash
    rlslone_config: "ENCRYPTED[!c294bf5706d6c34a709d60ac6f12f8ea189a2a05699c6902279df727b69563de1cc9d0253d0cf9bcc6efd40c84e3a3ff!]"
    GIT_TOKEN: "ENCRYPTED[!1877e8636cbcf281ffd947efb492bd083f8c0f6efebbd62a6eb386961499bcd9886d6e16f2052725cedc9987ff821058!]"
    TG_TOKEN: "ENCRYPTED[!ceca6b4c483b6931cd0e197a5c95d2e59c7044c3256c7d302f19f9445fbf643184716625a91792ba0b8c7398c66dd7d6!]"
    CCACHE_INDEX_DOWNLOAD_URL: "ENCRYPTED[!bc3b6f6889a31f2c161c65b201ec028a6cacb9da84f06f9db88025c64d2eb237eb0958cbc62168c40a040397608f509b!]"
    GIT_COOKIES_RAW_GIST: "ENCRYPTED[!ab44e19547a6aad4ac261a9e867205b92eaf071b51ce7922a82740d4f2e4c63d9a250f8a42305b714f5da550cad2b8db!]"

    
task:
    name: Build
    timeout_in: 2h
    container:
      image: madhavsheth/android_build_environment:latest
      cpu: 8
      memory: 32g
      greedy: true
    
    setupcc_script:
      - bash privatize_repo.sh
      - if [[ "$(tail -1 download_ccache.sh)" -ge "15" ]]; then echo "Build Failed!" && exit 1; fi
      - if [[ "$(tail -1 download_ccache.sh)" == "CCACHE_RUN=0" ]]; then echo 'skip ccache'; else bash download_ccache.sh ; fi
    additional_script:
      - bash additional.sh || true
    sync_script:
      - if ! timeout 15m bash sync.sh; then bash publisize_repo.sh && bash retry_sync.sh && sleep 5s; fi
    patch_script:
      - bash patch.sh
    build_script:
      - bash build.sh      
    ccupload_script:
      - bash upload_ccache.sh
    telegram_script:
      - bash tg.sh || true
      - sleep 10s
