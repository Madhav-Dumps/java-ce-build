env:
    CONFIG: env.conf
    CIRRUS_CLONE_DEPTH: 1
    CIRRUS_WORKING_DIR: "/tmp/ci"
    CIRRUS_SHELL: bash
    rlslone_config: "ENCRYPTED[!39d8059e4ebaf8a4304315e44102ab56b7607fc3bdc7ff9c15bec6f2db6834d1e6846743040263c25c00dcebfce18156!]"
    GIT_TOKEN: "ENCRYPTED[!2a14f937042f9f961e9f4b7b5737f8bc2a9ac86e2bc49fe20cdf59e5cacc8e8fedcc6e220d769b4e3e27894098b81383!]"
    TG_TOKEN: "ENCRYPTED[!accc29b5a6f309a7410dbaf460910125471d5951e4e298b182993d51242c71c38313818feeec512a51810da189d7be70!]"
    CCACHE_INDEX_DOWNLOAD_URL: "ENCRYPTED[!c7d1eb8415f7de20d85790ee59eb56b3ff415d378576420971a5cc5607035de092bcba28df4139fe0e4b5c778a6cfccc!]"
    GIT_COOKIES_RAW_GIST: "ENCRYPTED[!c7219504638882e56d929be0daf830f94eb2df19f6c26667efef1f25b1c463bd25690bc61eb3d1dda991e3f9d154450d!]"
    
task:
    name: Build
    timeout_in: 2h
    container:
      image: madhavsheth/android_build_environment:latest
      cpu: 8
      memory: 32g
      greedy: true
    
    setupcc_script:
      - bash privatize_repo.sh
      - if [[ "$(tail -1 download_ccache.sh)" -ge "15" ]]; then echo "Build Failed!" && exit 1; fi
      - if [[ "$(tail -1 download_ccache.sh)" == "CCACHE_RUN=0" ]]; then echo 'skip ccache'; else bash download_ccache.sh ; fi
    additional_script:
      - bash additional.sh || true
    sync_script:
      - if ! timeout 15m bash sync.sh; then bash publisize_repo.sh && bash retry_sync.sh && sleep 5s; fi
    patch_script:
      - bash patch.sh
    build_script:
      - bash build.sh      
    ccupload_script:
      - bash upload_ccache.sh
    telegram_script:
      - bash tg.sh || true
      - sleep 10s
